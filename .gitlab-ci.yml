stages:
  - pre-build
  - test
  - build
  - deploy

cache:
  paths:
    - node_modules/

default:
  tags:
    - docker

include:
  - remote: 'https://raw.githubusercontent.com/dimMaryanto93/gitlab-cicd-templates/main/build.angular.gitlab-ci.yml'
  - remote: 'https://raw.githubusercontent.com/dimMaryanto93/gitlab-cicd-templates/main/build.docker.gitlab-ci.yml'
  - remote: 'https://raw.githubusercontent.com/dimMaryanto93/gitlab-cicd-templates/main/trigger.deploy.gitlab-ci.yml'

ng:build:production:
  extends: .build-ng
  variables:
    NG_MEMORY_HEAP: "--max_old_space_size=8192"
    NODE_VERSION: "14.15-alpine"
  stage: build
  only:
    - /-release/

build:docker:
  stage: build
  extends: .build-docker
  variables:
    DOCKER_BUILD_ARGS_ENTRIPOINT: "--build-arg BUILD_FOLDER=dist/"
    DOCKERFILE_LOCATION: "-f Dockerfile"
  needs:
    - ng:build:production
    - get-fact:project:info
  only:
    - /-release/

trigger_deploy:
  extends: .trigger_pipeline
  stage: deploy
  needs:
    - get-fact:project:info
    - build:docker
  only:
    - /-release/
